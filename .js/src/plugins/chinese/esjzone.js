var t=this&&this.__awaiter||function(t,e,r,i){return new(r||(r=Promise))((function(n,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function s(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,s)}c((i=i.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var r,i,n,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(c){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(a=0)),a;)try{if(r=1,i&&(n=2&s[0]?i.return:s[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,s[1])).done)return n;switch(i=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,i=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(n=a.trys,(n=n.length>0&&n[n.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){a.label=s[1];break}if(6===s[0]&&a.label<n[1]){a.label=n[1],n=s;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(s);break}n[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],i=0}finally{r=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(exports,"__esModule",{value:!0});var r=require("cheerio"),i=require("@libs/fetch"),n=require("@libs/filterInputs"),a=require("@libs/novelStatus"),o=require("@libs/defaultCover"),s=require("@libs/storage"),c="collectedTags",l=function(){function l(){var t=this;this.id="esjzone",this.name="ESJZone",this.icon="src/cn/esjzone/icon.png",this.site="https://www.esjzone.cc",this.version="2.5.2",this.webStorageUtilized=!0,this.resolveUrl=function(e){return t.site+e},this.filters={category:{label:"分類",value:"1",options:[{label:"全部小說（需登入）",value:"0"},{label:"日本輕小說（需登入）",value:"1"},{label:"原創小說",value:"2"},{label:"韓國輕小說（需登入）",value:"3"}],type:n.FilterTypes.Picker},sort:{label:"排序",value:"1",options:[{label:"最新更新",value:"1"},{label:"最新上架",value:"2"},{label:"最高評分",value:"3"},{label:"最多觀看",value:"4"},{label:"最多文章",value:"5"},{label:"最多討論",value:"6"},{label:"最多收藏",value:"7"},{label:"最多字數",value:"8"}],type:n.FilterTypes.Picker},customTag:{label:"自訂標籤搜尋（單選＋自動完成）",value:[],options:[],maxSelections:1,type:n.FilterTypes.AutocompleteMulti}}}return l.prototype.refreshTagOptions=function(){var t=s.storage.get(c)||[];if(t.length>0){var e=t.slice().sort((function(t,e){return t.localeCompare(e,"zh")})).map((function(t){return{label:t,value:t}}));this.filters.customTag.options=e}},l.prototype.collectTags=function(t){for(var e=s.storage.get(c)||[],r=new Set(e),i=!1,n=0,a=t;n<a.length;n++){var o=a[n];o&&!r.has(o)&&(r.add(o),i=!0)}i&&s.storage.set(c,Array.from(r))},l.prototype.fetchTagPage=function(r,n){return t(this,void 0,void 0,(function(){var t,a;return e(this,(function(e){switch(e.label){case 0:return t=1===n?"".concat(this.site,"/tags/").concat(encodeURI(r),"/"):"".concat(this.site,"/tags/").concat(encodeURI(r),"/").concat(n,".html"),[4,(0,i.fetchText)(t)];case 1:return""===(a=e.sent())?[2,[]]:[2,this.parseNovelList(a)]}}))}))},l.prototype.fetchListPage=function(r,n,a){return t(this,void 0,void 0,(function(){var t,o,s;return e(this,(function(e){switch(e.label){case 0:return t="list-".concat(r).concat(n),o=1===a?"".concat(this.site,"/").concat(t,"/"):"".concat(this.site,"/").concat(t,"/").concat(a,".html"),[4,(0,i.fetchText)(o)];case 1:return""===(s=e.sent())?[2,[]]:[2,this.parseNovelList(s)]}}))}))},l.prototype.getSelectedTag=function(t){var e,r=null===(e=null==t?void 0:t.customTag)||void 0===e?void 0:e.value;if(Array.isArray(r))for(var i=0,n=r;i<n.length;i++){var a=n[i],o="string"==typeof a?a.trim():"";if(o)return o}else if(r&&"string"==typeof r&&""!==r.trim())return r.trim()},l.prototype.popularNovels=function(r,i){return t(this,arguments,void 0,(function(t,r){var i,n,a,s,c,l,u,h,f,d=r.filters;return e(this,(function(e){switch(e.label){case 0:return this.refreshTagOptions(),i=this.getSelectedTag(d),n=(null===(h=null==d?void 0:d.category)||void 0===h?void 0:h.value)||"1",a=(null===(f=null==d?void 0:d.sort)||void 0===f?void 0:f.value)||"1",i?[4,this.fetchTagPage(i,t)]:[3,3];case 1:return s=e.sent(),"1"===n&&"1"===a?[2,s]:[4,this.fetchListPage(n,a,t)];case 2:return c=e.sent(),l=new Set(c.map((function(t){return t.path}))),[2,s.filter((function(t){return l.has(t.path)}))];case 3:return[4,this.fetchListPage(n,a,t)];case 4:return 0===(u=e.sent()).length&&"2"!==n?[2,[{name:"⚠ 需要登入才能瀏覽輕小說 — 請先在 WebView 中登入",path:"/my/login",cover:o.defaultCover}]]:[2,u]}}))}))},l.prototype.parseNovelList=function(t){var e=this,i=(0,r.load)(t),n=[];return i("div.card.mb-30").each((function(t,r){var a=i(r),s=a.find("a.card-img-tiles").attr("href");if(s){var c,l=a.find(".card-title a").text().trim(),u=a.find(".main-img .lazyload").attr("data-src")||"";u.includes("/assets/img/empty.jpg")||""===u?u=o.defaultCover:u.startsWith("/")&&!u.startsWith("//")&&(u=e.site+u);var h=a.find(".product-badge").text().trim();("18+"===h||/\bR-?18\b/i.test(h)||/\b18\+/.test(h))&&(c="R18");var f="",d="";a.find(".card-other .column").each((function(t,e){var r=i(e);r.find(".icon-star-s").length>0?f=r.text().trim():r.find(".icon-file-text").length>0&&(d=r.text().trim())}));var p=[];f&&"0"!==f&&p.push("★"+f),d&&p.push(d+"字");var v={name:l,path:s,cover:u};c&&(v.badge=c),p.length>0&&(v.info=p.join(" | ")),n.push(v)}})),n},l.prototype.parseNovel=function(n){return t(this,void 0,void 0,(function(){var t,s,c,l,u,h,f,d,p,v,m,g,b,y,w,x,T,W=this;return e(this,(function(e){switch(e.label){case 0:return t=this.site+n,[4,(0,i.fetchText)(t)];case 1:if(""===(s=e.sent()))throw Error("無法獲取小說資訊，請檢查網路");return c=(0,r.load)(s),l=c("body").text(),u=l.includes("請先登入")||l.includes("请先登入")||l.includes("登入 / 註冊"),h=c("h2.text-normal"),!(h.length>0)&&u?((f={path:n,chapters:[],name:"需要登入才能瀏覽此作品",summary:"此作品需要登入 ESJZone 帳號才能瀏覽。\n請在 WebView 中開啟此頁面並登入後重試。\n\n操作步驟：\n1. 點擊右上角的 WebView 圖示\n2. 在網頁中登入 ESJZone 帳號\n3. 返回後重新整理此頁面"}).cover=o.defaultCover,[2,f]):(d={path:n,chapters:[],name:h.text().trim()||"Untitled"},p=c("div.product-gallery img").attr("src")||"",d.cover=p?p.startsWith("/")?this.site+p:p:o.defaultCover,c("ul.book-detail li").each((function(t,e){var r=c(e).text().trim();if((r.startsWith("作者:")||r.startsWith("作者："))&&(d.author=c(e).find("a").text().trim()||r.replace(/作者[:：]\s*/,"")),r.startsWith("類型:")||r.startsWith("類型：")){var i=r.replace(/類型[:：]\s*/,"").trim();i&&(d.status=i.includes("完結")?a.NovelStatus.Completed:a.NovelStatus.Ongoing)}var n=r.match(/(?:字數|總字數)[:：]?\s*([\d,]+)/);if(n){var o=parseInt(n[1].replace(/,/g,""),10);!isNaN(o)&&o>0&&(d.wordCount=o)}})),d.status||(d.status=a.NovelStatus.Ongoing),(v=c("div.d-inline.display-3").first().text().trim())&&(m=parseFloat(v),isNaN(m)||(d.rating=m)),(g=c("div.description")).length&&(d.summary=g.text().trim()),b=new Set,c("section.widget-tags a.tag").each((function(t,e){var r=c(e).text().trim();r&&b.add(r)})),0===b.size&&c("a.tag").each((function(t,e){if((c(e).attr("href")||"").startsWith("/tags/")){var r=c(e).text().trim();r&&b.add(r)}})),(y=Array.from(b)).length>0&&(d.genres=y.join(","),this.collectTags(y)),w="",c("ul.book-detail li").each((function(t,e){var r=c(e).text().trim();if(r.startsWith("更新日期:")||r.startsWith("更新日期：")){var i=r.match(/(\d{4}[-/]\d{1,2}[-/]\d{1,2})/);i&&(w=i[1])}})),x=[],T=0,c("#chapterList a").each((function(t,e){var r,i=c(e).attr("href");if(i){var n=(null===(r=c(e).attr("data-title"))||void 0===r?void 0:r.trim())||c(e).text().trim();if(n){T++;var a=i;a.startsWith(W.site)?a=a.replace(W.site,""):a.startsWith("https://www.esjzone.cc")&&(a=a.replace("https://www.esjzone.cc","")),x.push({name:n,path:a,chapterNumber:T})}}})),w&&x.length>0&&(x[0].releaseTime=w),d.chapters=x,[2,d])}}))}))},l.prototype.parseChapter=function(n){return t(this,void 0,void 0,(function(){var t,a,o,s,c,l;return e(this,(function(e){switch(e.label){case 0:return t=this.site+n,[4,(0,i.fetchText)(t)];case 1:if(""===(a=e.sent()))throw Error("無法獲取章節內容，請檢查網路");return o=(0,r.load)(a),s=o("body").text(),c=o("div.forum-content").length>0,s.includes("請先登入")||s.includes("请先登入")||s.includes("請登入後再訪問")||s.includes("需要登入")||!c&&s.includes("登入 / 註冊")?[2,'<p style="text-align:center;color:red;font-weight:bold;">此內容需要登入才能閱讀。<br/>請點擊右上角 WebView 圖示，在網頁中登入 ESJZone 帳號後返回重試。</p>']:s.includes("成人確認")||s.includes("年齡確認")||s.includes("未成年請勿")||s.includes("18歲以上")?[2,'<p style="text-align:center;color:red;font-weight:bold;">此內容需要成人驗證。<br/>請在 WebView 中完成年齡確認後重試。</p>']:s.includes("密碼")||s.includes("密码")||o('input[type="password"]').length>0?[2,'<p style="text-align:center;color:red;font-weight:bold;">此章節受密碼保護，無法直接閱讀。</p>']:0===(l=o("div.forum-content")).length?[2,"<p>無法找到章節內容。</p>"]:(l.find("script, style, .ad, ins.adsbygoogle").remove(),[2,l.html()||""])}}))}))},l.prototype.searchNovels=function(r,n){return t(this,void 0,void 0,(function(){var t,a;return e(this,(function(e){switch(e.label){case 0:return t=1===n?"".concat(this.site,"/tags/").concat(encodeURI(r),"/"):"".concat(this.site,"/tags/").concat(encodeURI(r),"/").concat(n,".html"),[4,(0,i.fetchText)(t)];case 1:return""===(a=e.sent())?[2,[]]:[2,this.parseNovelList(a)]}}))}))},l.prototype.parseComments=function(n){return t(this,void 0,void 0,(function(){var t,a,o,s,c=this;return e(this,(function(e){switch(e.label){case 0:return t=this.site+n,[4,(0,i.fetchText)(t)];case 1:return""===(a=e.sent())?[2,[]]:(o=(0,r.load)(a),s=[],o("section.comments-section .comment").each((function(t,e){var r=o(e),i=r.find(".comment-title a").first().text().trim()||r.find(".comment-title").first().text().trim()||"",n=r.find(".comment-meta").not(".comment-floor").first().text().trim(),a=r.find(".lazyload-author-ava").first().attr("data-src")||"",l=r.find("blockquote p").text().trim(),u=r.find("p.comment-text").first().text().trim(),h=l?"「".concat(l,"」\n").concat(u):u;h&&s.push({author:i||"匿名",content:h,date:n||void 0,avatar:a?a.startsWith("http")?a:"".concat(c.site).concat(a):void 0})})),[2,s])}}))}))},l}();exports.default=new l;